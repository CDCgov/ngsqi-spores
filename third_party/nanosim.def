Bootstrap: docker
From: ubuntu:22.04

%post
    # Install system dependencies
    apt-get update
    apt-get install -y wget bzip2 ca-certificates curl git
    apt-get clean
    
    # Install Miniconda
    mkdir -p /opt
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /opt/miniconda.sh
    bash /opt/miniconda.sh -b -p /opt/conda
    rm /opt/miniconda.sh
    
    # Set up environment variables
    echo 'export PATH=/opt/conda/bin:$PATH' > /etc/profile.d/conda.sh
    export PATH=/opt/conda/bin:$PATH
    
    # Create the nanosim environment
    conda create -n nanosim python=3.12
    
    # Activate and install packages
    . /opt/conda/etc/profile.d/conda.sh
    conda activate nanosim
    
    # Add conda channels
    conda config --add channels conda-forge
    conda config --add channels bioconda
    conda config --add channels defaults
    
    # Install core packages from conda
    conda install -y \
        nanosim=3.2.2 \
        bedtools=2.31.1 \
        htseq=2.0.5 \
        htslib=1.21 \
        last=1608 \
        matplotlib-base=3.10.0 \
        minimap2=2.28 \
        numpy=1.26.4 \
        pandas=2.2.2 \
        pybedtools=0.11.0 \
        pysam=0.22.1 \
        regex=2024.11.6 \
        sam2pairwise=1.0.0 \
        samtools=1.21 \
        scikit-learn=1.6.1 \
        scipy=1.15.1 \
        statsmodels=0.14.4
    
    # Install pip packages
    pip install \
        cycler==0.12.1 \
        joblib==1.4.2 \
        packaging==24.2 \
        patsy==1.0.1 \
        piecewise-regression==1.1.2 \
        pyparsing==3.2.1 \
        python-dateutil==2.9.0.post0 \
        pytz==2024.2 \
        six==1.17.0 \
        threadpoolctl==3.5.0
    
    # Clean up
    conda clean -afy

%environment
    export PATH=/opt/conda/bin:$PATH
    . /opt/conda/etc/profile.d/conda.sh
    conda activate nanosim

%runscript
    exec "$@"

%labels
    Author YourName
    Version 1.0
    Description NanoSim container with all dependencies

%help
    This container provides NanoSim (v3.2.2) and its dependencies.
    
    Usage:
    singularity run nanosim.sif nanosim command [options]
    
    Example:
    singularity run nanosim.sif simulator.py -h